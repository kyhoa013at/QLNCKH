@page "/nopchuyende"
@using MudBlazor
@using QLNCKH_HocVien.Client.Models
@using QLNCKH_HocVien.Client.Services
@using QLNCKH_HocVien.Client.Exceptions
@using QLNCKH_HocVien.Client.Shared
@inject NopSanPhamService NopService
@inject NavigationManager Navigation
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject AuthService AuthService

<PageHeader Title="NỘP SẢN PHẨM CHUYÊN ĐỀ" 
            Subtitle="Nộp và quản lý sản phẩm chuyên đề nghiên cứu khoa học" 
            Icon="@Icons.Material.Filled.Upload">
    @if (_isAdmin || _isHocVien)
    {
        <MudButton Variant="Variant.Filled" 
                   Color="Color.Surface" 
                   StartIcon="@Icons.Material.Filled.Add"
                   OnClick="OpenAddDialog"
                   Disabled="@_isLoading"
                   Style="color: white;">
            Nộp sản phẩm
        </MudButton>
    }
</PageHeader>

<MudPaper Elevation="2" Class="pa-4">
    @* Search & Filter Bar *@
    <div class="d-flex gap-3 mb-4 flex-wrap">
        <MudTextField @bind-Value="_searchText"
                      Placeholder="Tìm kiếm theo mã CD, tên chuyên đề..."
                      Variant="Variant.Outlined"
                      Adornment="Adornment.Start"
                      AdornmentIcon="@Icons.Material.Filled.Search"
                      Immediate="true"
                      DebounceInterval="500"
                      OnDebounceIntervalElapsed="OnSearchChanged"
                      Style="max-width: 400px;"
                      Class="flex-grow-1" />
        
        <MudSelect T="int?" 
                   Value="_selectedChuyenDe"
                   Label="Chuyên đề"
                   Variant="Variant.Outlined"
                   Clearable="true"
                   Style="width: 250px;"
                   ValueChanged="@(async (int? cd) => await OnChuyenDeChanged(cd))">
            <MudSelectItem Value="@((int?)null)">Tất cả</MudSelectItem>
            @foreach (var cd in _dsChuyenDe)
            {
                <MudSelectItem T="int?" Value="@cd.Id">@cd.MaSoCD - @cd.TenChuyenDe</MudSelectItem>
            }
        </MudSelect>
        
        <MudSelect T="TrangThaiNop?" 
                   Value="_selectedTrangThai"
                   Label="Trạng thái"
                   Variant="Variant.Outlined"
                   Clearable="true"
                   Style="width: 180px;"
                   ValueChanged="@(async (TrangThaiNop? tt) => await OnTrangThaiChanged(tt))">
            <MudSelectItem T="TrangThaiNop?" Value="@((TrangThaiNop?)null)">Tất cả</MudSelectItem>
            <MudSelectItem T="TrangThaiNop?" Value="@TrangThaiNop.NopBanMem">Nộp bản mềm</MudSelectItem>
            <MudSelectItem T="TrangThaiNop?" Value="@TrangThaiNop.NopBanCung">Nộp bản cứng</MudSelectItem>
            <MudSelectItem T="TrangThaiNop?" Value="@TrangThaiNop.NopSauChinhSua">Nộp sau chỉnh sửa</MudSelectItem>
        </MudSelect>
        
        <MudSelect T="int" 
                   Value="_pageSize" 
                   Label="Hiển thị"
                   Variant="Variant.Outlined"
                   Style="width: 120px;"
                   ValueChanged="@(async (int size) => await OnPageSizeChanged(size))">
            <MudSelectItem Value="5">5 / trang</MudSelectItem>
            <MudSelectItem Value="10">10 / trang</MudSelectItem>
            <MudSelectItem Value="25">25 / trang</MudSelectItem>
            <MudSelectItem Value="50">50 / trang</MudSelectItem>
        </MudSelect>
    </div>

    @* Data Table *@
    @if (_isLoading && _dsDaNop.Count == 0)
    {
        <TableSkeleton Rows="5" Columns="6" />
    }
    else
    {
        <MudTable Items="@_dsDaNop" 
                  Hover="true" 
                  Striped="true"
                  Dense="true"
                  Loading="@_isLoading"
                  LoadingProgressColor="Color.Primary"
                  Elevation="0"
                  Class="mb-4">
            <HeaderContent>
                <MudTh Style="width: 60px;">STT</MudTh>
                <MudTh>Mã CD</MudTh>
                <MudTh>Tên chuyên đề</MudTh>
                <MudTh>Người nộp</MudTh>
                <MudTh>Trạng thái</MudTh>
                <MudTh>Ngày nộp</MudTh>
                <MudTh Style="width: 150px;">Thao tác</MudTh>
            </HeaderContent>
            <RowTemplate>
                @{
                    var cd = _dsChuyenDe.FirstOrDefault(x => x.Id == context.IdChuyenDe);
                    var sv = _dsSinhVien.FirstOrDefault(x => x.Id == cd?.IdHocVien);
                }
                <MudTd DataLabel="STT" Style="text-align: center;">
                    @((_currentPage - 1) * _pageSize + _dsDaNop.IndexOf(context) + 1)
                </MudTd>
                <MudTd DataLabel="Mã CD">
                    <MudChip T="string" Color="Color.Primary" Size="Size.Small">@cd?.MaSoCD</MudChip>
                </MudTd>
                <MudTd DataLabel="Tên chuyên đề">
                    <MudText Typo="Typo.body2" Style="font-weight: 500;">@cd?.TenChuyenDe</MudText>
                </MudTd>
                <MudTd DataLabel="Người nộp">
                    @if (sv != null)
                    {
                        <MudText Typo="Typo.body2" Style="font-weight: 500;">@sv.HoTen</MudText>
                    }
                    else
                    {
                        <MudText Typo="Typo.body2" Color="Color.Error">Không tìm thấy</MudText>
                    }
                </MudTd>
                <MudTd DataLabel="Trạng thái">
                    @switch (context.TrangThai)
                    {
                        case TrangThaiNop.NopBanMem:
                            <MudChip T="string" Color="Color.Info" Size="Size.Small">Bản mềm</MudChip>
                            break;
                        case TrangThaiNop.NopBanCung:
                            <MudChip T="string" Color="Color.Success" Size="Size.Small">Bản cứng</MudChip>
                            break;
                        case TrangThaiNop.NopSauChinhSua:
                            <MudChip T="string" Color="Color.Warning" Size="Size.Small">Đã sửa</MudChip>
                            break;
                    }
                </MudTd>
                <MudTd DataLabel="Ngày nộp">
                    <MudText Typo="Typo.body2">@context.NgayNop.ToString("dd/MM/yyyy HH:mm")</MudText>
                </MudTd>
                <MudTd DataLabel="Thao tác">
                    @if (!string.IsNullOrEmpty(context.GhiChu))
                    {
                        <MudTooltip Text="@context.GhiChu">
                            <MudIconButton Icon="@Icons.Material.Filled.Info" 
                                           Color="Color.Info" 
                                           Size="Size.Small" />
                        </MudTooltip>
                    }
                    @if (_isAdmin || (_isHocVien && CanDeleteNop(context)))
                    {
                        <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                       Color="Color.Error" 
                                       Size="Size.Small"
                                       OnClick="@(() => ConfirmDelete(context))" />
                    }
                </MudTd>
            </RowTemplate>
            <NoRecordsContent>
                <MudAlert Severity="Severity.Info" Class="my-4">
                    @if (string.IsNullOrEmpty(_searchText) && !_selectedChuyenDe.HasValue && !_selectedTrangThai.HasValue)
                    {
                        <span>Chưa có sản phẩm nào được nộp</span>
                    }
                    else
                    {
                        <span>Không tìm thấy sản phẩm phù hợp</span>
                    }
                </MudAlert>
            </NoRecordsContent>
        </MudTable>

        @* Pagination *@
        <div class="d-flex justify-space-between align-center flex-wrap gap-2">
            <MudText Typo="Typo.body2" Color="Color.Secondary">
                Hiển thị @((_currentPage - 1) * _pageSize + 1) - @Math.Min(_currentPage * _pageSize, _totalCount) 
                trong tổng số @_totalCount sản phẩm
            </MudText>
            
            <MudPagination Count="@_totalPages" 
                          Selected="@_currentPage"
                          ShowFirstButton="true"
                          ShowLastButton="true"
                          Color="Color.Primary"
                          Variant="Variant.Outlined"
                          SelectedChanged="@(async (int page) => await OnPageChanged(page))" />
        </div>
    }
</MudPaper>

@* Add Dialog *@
<MudDialog @bind-Visible="_showFormDialog" Options="@_dialogOptions">
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.Upload" Class="mr-2" />
            Nộp sản phẩm chuyên đề
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudForm @ref="_form" @bind-IsValid="@_formIsValid">
            <MudGrid Spacing="3">
                <MudItem xs="12">
                    <MudSelect T="int" 
                               @bind-Value="_baiNopForm.IdChuyenDe"
                               Label="Chọn chuyên đề *"
                               Variant="Variant.Outlined"
                               Required="true"
                               RequiredError="Vui lòng chọn chuyên đề">
                        <MudSelectItem Value="0">-- Chọn chuyên đề --</MudSelectItem>
                        @foreach (var cd in _dsChuyenDe)
                        {
                            <MudSelectItem Value="@cd.Id">@cd.MaSoCD - @cd.TenChuyenDe</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>
                @if (_baiNopForm.IdChuyenDe > 0)
                {
                    var cdChon = _dsChuyenDe.FirstOrDefault(x => x.Id == _baiNopForm.IdChuyenDe);
                    var svThucHien = _dsSinhVien.FirstOrDefault(x => x.Id == cdChon?.IdHocVien);
                    <MudItem xs="12">
                        <MudAlert Severity="Severity.Info" Dense="true">
                            <strong>Tên CD:</strong> @cdChon?.TenChuyenDe<br />
                            <strong>Người nộp (Thành viên):</strong> <span style="font-weight: 600;">@svThucHien?.HoTen</span><br />
                            <strong>Lớp:</strong> @svThucHien?.Lop
                        </MudAlert>
                    </MudItem>
                }
                <MudItem xs="12">
                    <MudSelect T="TrangThaiNop"
                               @bind-Value="_baiNopForm.TrangThai"
                               Label="Trạng thái nộp *"
                               Variant="Variant.Outlined"
                               Required="true"
                               RequiredError="Vui lòng chọn trạng thái">
                        <MudSelectItem T="TrangThaiNop" Value="@TrangThaiNop.NopBanMem">Nộp bản mềm</MudSelectItem>
                        <MudSelectItem T="TrangThaiNop" Value="@TrangThaiNop.NopBanCung">Nộp bản cứng</MudSelectItem>
                        <MudSelectItem T="TrangThaiNop" Value="@TrangThaiNop.NopSauChinhSua">Nộp sau chỉnh sửa</MudSelectItem>
                    </MudSelect>
                </MudItem>
                <MudItem xs="12">
                    <MudTextField @bind-Value="_baiNopForm.GhiChu"
                                  Label="Ghi chú / Link sản phẩm"
                                  Variant="Variant.Outlined"
                                  Lines="3"
                                  Placeholder="Nhập link driver hoặc ghi chú thêm..." />
                </MudItem>
            </MudGrid>
        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="CloseFormDialog" Disabled="@_isSaving">Hủy</MudButton>
        <MudButton Color="Color.Primary" 
                   Variant="Variant.Filled"
                   OnClick="SaveNop"
                   Disabled="@(!_formIsValid || _isSaving || _baiNopForm.IdChuyenDe == 0)">
            @if (_isSaving)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                <span>Đang lưu...</span>
            }
            else
            {
                <MudIcon Icon="@Icons.Material.Filled.Save" Class="mr-1" />
                <span>Xác nhận nộp</span>
            }
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    // Data
    private List<NopSanPham> _dsDaNop = new();
    private List<ChuyenDeNCKH> _dsChuyenDe = new();
    private List<SinhVien> _dsSinhVien = new();

    // Pagination
    private int _currentPage = 1;
    private int _pageSize = 10;
    private int _totalCount = 0;
    private int _totalPages => (int)Math.Ceiling(_totalCount / (double)_pageSize);

    // Search & Filter
    private string _searchText = "";
    private int? _selectedChuyenDe = null;
    private TrangThaiNop? _selectedTrangThai = null;

    // Form
    private NopSanPham _baiNopForm = new();
    private bool _showFormDialog = false;
    private bool _formIsValid = false;
    private bool _isSaving = false;
    private MudForm? _form;

    // Loading
    private bool _isLoading = false;

    // Authorization
    private bool _isAdmin = false;
    private bool _isHocVien = false;
    private int _currentUserId = 0;

    // Dialog options
    private DialogOptions _dialogOptions = new()
    {
        MaxWidth = MaxWidth.Medium,
        FullWidth = true,
        CloseOnEscapeKey = true,
        BackdropClick = false
    };

    protected override async Task OnInitializedAsync()
    {
        // Kiểm tra quyền truy cập
        var currentUser = await AuthService.GetCurrentUser();
        if (currentUser == null)
        {
            Navigation.NavigateTo("/login", forceLoad: true);
            return;
        }

        _isAdmin = currentUser.VaiTro == "Admin";
        _isHocVien = currentUser.VaiTro == "User";
        _currentUserId = currentUser.Id;
        StateHasChanged(); // Cập nhật UI sau khi set authorization

        // Tất cả đều có thể xem, nhưng chỉ Admin và User có thể nộp

        try
        {
            // Load catalogs in parallel
            var tasks = new[]
            {
                LoadCatalogAsync(async () => _dsChuyenDe = await NopService.LayDsChuyenDe()),
                LoadCatalogAsync(async () => _dsSinhVien = await NopService.LayDsSinhVien())
            };
            await Task.WhenAll(tasks);

            // Load data
            await LoadDataAsync();
        }
        catch (UnauthorizedException)
        {
            Navigation.NavigateTo("/access-denied", forceLoad: true);
        }
    }

    private async Task LoadCatalogAsync(Func<Task> action)
    {
        try { await action(); } catch { }
    }

    private async Task LoadDataAsync()
    {
        try
        {
            _isLoading = true;
            StateHasChanged();

            var result = await NopService.LayDanhSachPhanTrang(_currentPage, _pageSize, _selectedChuyenDe, _selectedTrangThai);
            _dsDaNop = result.Data ?? new List<NopSanPham>();
            _totalCount = result.TotalCount;
        }
        catch (UnauthorizedException)
        {
            Navigation.NavigateTo("/access-denied", forceLoad: true);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Lỗi tải dữ liệu: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task OnSearchChanged(string value)
    {
        _searchText = value;
        _currentPage = 1;
        // Note: Search sẽ được xử lý ở server nếu API hỗ trợ
        await LoadDataAsync();
    }

    private async Task OnChuyenDeChanged(int? chuyenDe)
    {
        _selectedChuyenDe = chuyenDe;
        _currentPage = 1;
        await LoadDataAsync();
    }

    private async Task OnTrangThaiChanged(TrangThaiNop? trangThai)
    {
        _selectedTrangThai = trangThai;
        _currentPage = 1;
        await LoadDataAsync();
    }

    private async Task OnPageChanged(int page)
    {
        _currentPage = page;
        await LoadDataAsync();
    }

    private async Task OnPageSizeChanged(int size)
    {
        _pageSize = size;
        _currentPage = 1;
        await LoadDataAsync();
    }

    private void OpenAddDialog()
    {
        _baiNopForm = new NopSanPham { TrangThai = TrangThaiNop.NopBanMem };
        _showFormDialog = true;
    }

    private void CloseFormDialog()
    {
        if (!_isSaving)
        {
            _showFormDialog = false;
        }
    }

    private async Task SaveNop()
    {
        if (_form != null)
        {
            await _form.Validate();
            if (!_formIsValid) return;
        }

        if (_baiNopForm.IdChuyenDe == 0)
        {
            Snackbar.Add("Vui lòng chọn chuyên đề cần nộp!", Severity.Warning);
            return;
        }

        try
        {
            _isSaving = true;
            _baiNopForm.NgayNop = DateTime.Now;

            var result = await NopService.NopBai(_baiNopForm);
            if (result.Success)
            {
                Snackbar.Add("Nộp sản phẩm thành công!", Severity.Success);
                _showFormDialog = false;
                _baiNopForm = new NopSanPham();
                await LoadDataAsync();
            }
            else
            {
                Snackbar.Add(result.Message, Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Lỗi: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isSaving = false;
        }
    }

    private async Task ConfirmDelete(NopSanPham nop)
    {
        var cd = _dsChuyenDe.FirstOrDefault(x => x.Id == nop.IdChuyenDe);
        var parameters = new DialogParameters
        {
            ["ContentText"] = $"Bạn có chắc chắn muốn xóa lịch sử nộp sản phẩm cho chuyên đề '{cd?.TenChuyenDe}'?",
            ["ConfirmText"] = "Xóa",
            ["Icon"] = Icons.Material.Filled.DeleteForever,
            ["IconColor"] = Color.Error
        };

        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small };
        var dialog = await DialogService.ShowAsync<ConfirmDialog>("Xác nhận xóa", parameters, options);
        var result = await dialog.Result;

        if (result != null && !result.Canceled)
        {
            await DeleteNop(nop.Id);
        }
    }

    private bool CanDeleteNop(NopSanPham nop)
    {
        // User chỉ có thể xóa sản phẩm của chuyên đề của mình
        // Cần kiểm tra IdHocVien của chuyên đề
        // Tạm thời cho phép nếu là User (sẽ kiểm tra ở server)
        return _isHocVien;
    }

    private async Task DeleteNop(int id)
    {
        try
        {
            _isLoading = true;
            var result = await NopService.XoaNop(id);
            
            if (result.Success)
            {
                Snackbar.Add("Xóa lịch sử nộp thành công!", Severity.Success);
                await LoadDataAsync();
            }
            else
            {
                Snackbar.Add(result.Message, Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Lỗi xóa: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }
}
