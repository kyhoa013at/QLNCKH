@page "/capnhatketqua"
@using MudBlazor
@using QLNCKH_HocVien.Client.Models
@using QLNCKH_HocVien.Client.Services
@using QLNCKH_HocVien.Client.Exceptions
@using QLNCKH_HocVien.Client.Shared
@inject KetQuaService KqService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject AuthService AuthService

<PageHeader Title="CẬP NHẬT KẾT QUẢ CHẤM" 
            Subtitle="Cập nhật điểm chấm cho vòng Sơ Loại và Chung Khảo" 
            Icon="@Icons.Material.Filled.Assessment">
    @if (_activeTab == 1 && _isAdmin)
    {
        <MudButton Variant="Variant.Filled" 
                   Color="Color.Warning" 
                   StartIcon="@Icons.Material.Filled.AutoAwesome"
                   OnClick="AutoXetDuyet"
                   Disabled="@_isProcessing">
            @if (_isProcessing)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                <span>Đang xử lý...</span>
            }
            else
            {
                <span>Tự động xét duyệt Top 15</span>
            }
        </MudButton>
    }
</PageHeader>

<MudPaper Elevation="2" Class="pa-4 mb-4">
    <MudTabs ActivePanelIndex="@(_activeTab - 1)" 
             ActivePanelIndexChanged="@((int idx) => { _activeTab = idx + 1; StateHasChanged(); })"
             Variant="Variant.Pills" 
             Color="Color.Primary" 
             Class="mb-4">
        <MudTabPanel Text="Vòng Sơ Loại">
            <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-3">
                Chấm điểm và xét duyệt các chuyên đề vòng sơ loại (1 người chấm)
            </MudText>
        </MudTabPanel>
        <MudTabPanel Text="Vòng Chung Khảo">
            <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-3">
                Chấm điểm chi tiết cho các chuyên đề đã qua vòng sơ loại (Hội đồng chấm)
            </MudText>
        </MudTabPanel>
    </MudTabs>
</MudPaper>

@if (_activeTab == 1)
{
    @* VÒNG SƠ LOẠI *@
    <MudPaper Elevation="2" Class="pa-4">
        @if (_isLoading && _dsChuyenDe.Count == 0)
        {
            <TableSkeleton Rows="5" Columns="5" />
        }
        else
        {
            <MudTable Items="@_dsChuyenDe" 
                      Hover="true" 
                      Striped="true"
                      Dense="true"
                      Loading="@_isLoading"
                      LoadingProgressColor="Color.Primary"
                      Elevation="0">
                <HeaderContent>
                    <MudTh Style="width: 60px;">STT</MudTh>
                    <MudTh>Mã CD</MudTh>
                    <MudTh>Tên chuyên đề</MudTh>
                    <MudTh Style="width: 150px;">Điểm chấm</MudTh>
                    <MudTh Style="width: 150px;">Kết quả</MudTh>
                    <MudTh Style="width: 200px;">Nhận xét</MudTh>
                    <MudTh Style="width: 120px;">Thao tác</MudTh>
                </HeaderContent>
                <RowTemplate>
                    @{
                        var kq = _dsKqSoLoai.FirstOrDefault(x => x.IdChuyenDe == context.Id);
                        if (kq == null)
                        {
                            kq = new KetQuaSoLoai 
                            { 
                                Id = 0,
                                IdChuyenDe = context.Id,
                                DiemSo = 0,
                                KetQua = false
                            };
                            // Thêm vào list để binding hoạt động đúng
                            _dsKqSoLoai.Add(kq);
                        }
                    }
                    <MudTd DataLabel="STT" Style="text-align: center;">
                        @(_dsChuyenDe.IndexOf(context) + 1)
                    </MudTd>
                    <MudTd DataLabel="Mã CD">
                        <MudChip T="string" Color="Color.Primary" Size="Size.Small">@context.MaSoCD</MudChip>
                    </MudTd>
                    <MudTd DataLabel="Tên chuyên đề">
                        <MudText Typo="Typo.body2" Style="font-weight: 500;">@context.TenChuyenDe</MudText>
                    </MudTd>
                    <MudTd DataLabel="Điểm chấm">
                        <MudNumericField T="double"
                            @bind-Value="kq.DiemSo"
                            Variant="Variant.Outlined"
                            Min="0"
                            Max="10"
                            Step="0.1"
                            Adornment="Adornment.End"
                            AdornmentText="điểm"
                            Style="width: 100%;" />
                    </MudTd>
                    <MudTd DataLabel="Kết quả">
                        <MudSwitch T="bool"
                                   @bind-Checked="kq.KetQua" 
                                   Color="@(kq.KetQua ? Color.Success : Color.Error)"
                                   Label="@(kq.KetQua ? "Được đi tiếp" : "Loại")" />
                    </MudTd>
                    <MudTd DataLabel="Nhận xét">
                        <MudTextField @bind-Value="kq.NhanXet"
                                      Variant="Variant.Outlined"
                                      Placeholder="Nhập nhận xét..."
                                      Lines="2"
                                      Style="width: 100%;" />
                    </MudTd>
                    <MudTd DataLabel="Thao tác">
                        <MudButton Variant="Variant.Filled" 
                                   Color="Color.Primary"
                                   Size="Size.Small"
                                   StartIcon="@Icons.Material.Filled.Save"
                                   OnClick="@(() => LuuSoLoai(kq))"
                                   Disabled="@(_isSaving || kq.DiemSo < 0 || kq.DiemSo > 10)">
                            Lưu
                        </MudButton>
                    </MudTd>
                </RowTemplate>
                <NoRecordsContent>
                    <MudAlert Severity="Severity.Info" Class="my-4">
                        Chưa có chuyên đề nào được đăng ký
                    </MudAlert>
                </NoRecordsContent>
            </MudTable>
        }
    </MudPaper>
}
else
{
    @* VÒNG CHUNG KHẢO *@
    var chuyenDeChungKhao = _dsChuyenDe.Where(x => IsPassSoLoai(x.Id)).ToList();
    
    @if (chuyenDeChungKhao.Count == 0)
    {
        <MudAlert Severity="Severity.Warning" Class="mb-4">
            Chưa có chuyên đề nào vượt qua vòng sơ loại hoặc chưa có hội đồng chấm chung khảo.
        </MudAlert>
    }
    else
    {
        @foreach (var cd in chuyenDeChungKhao)
        {
            var hd = _dsHoiDong.FirstOrDefault(x => x.IdChuyenDe == cd.Id && x.VongThi == VongCham.ChungKhao);
            if (hd == null) continue;

            var diemTB = CalcAverage(cd.Id);
            var soPhieuCham = _dsPhieuChamAll.Count(x => x.IdChuyenDe == cd.Id && x.Diem > 0);

            <MudPaper Elevation="2" Class="pa-4 mb-4">
                <div class="d-flex justify-space-between align-center mb-3 flex-wrap gap-2">
                    <div>
                        <MudText Typo="Typo.h6" Style="font-weight: 600;">
                            <MudChip T="string" Color="Color.Primary" Size="Size.Small" Class="mr-2">@cd.MaSoCD</MudChip>
                            @cd.TenChuyenDe
                        </MudText>
                    </div>
                    <div class="d-flex align-center gap-3">
                        <MudChip T="string" 
                                 Color="@(diemTB >= 8 ? Color.Success : diemTB >= 6 ? Color.Warning : Color.Error)" 
                                 Size="Size.Medium"
                                 Icon="@Icons.Material.Filled.Star">
                            Điểm TB: @diemTB.ToString("0.00")
                        </MudChip>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">
                            (@soPhieuCham / @hd.ThanhViens.Count phiếu)
                        </MudText>
                    </div>
                </div>

                <MudTable Items="@hd.ThanhViens" 
                          Hover="true" 
                          Striped="true"
                          Dense="true"
                          Elevation="0">
                    <HeaderContent>
                        <MudTh>Thành viên hội đồng</MudTh>
                        <MudTh Style="width: 120px;">Vai trò</MudTh>
                        <MudTh Style="width: 180px;">Điểm chấm</MudTh>
                        <MudTh>Ý kiến</MudTh>
                        <MudTh Style="width: 120px;">Thao tác</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        @{
                            var gv = _dsGiaoVien.FirstOrDefault(x => x.Id == context.IdGiaoVien);
                            var pc = GetPhieuCham(cd.Id, context.IdGiaoVien);
                        }
                        <MudTd DataLabel="Thành viên">
                            <MudText Typo="Typo.body2" Style="font-weight: 500;">@gv?.HoTen</MudText>
                        </MudTd>
                        <MudTd DataLabel="Vai trò">
                            <MudChip T="string" 
                                     Color="@(context.VaiTro == "Chủ tịch" ? Color.Error : context.VaiTro == "Thư ký" ? Color.Info : Color.Default)" 
                                     Size="Size.Small">
                                @context.VaiTro
                            </MudChip>
                        </MudTd>
                        <MudTd DataLabel="Điểm chấm">
                            <MudNumericField T="double"
                                @bind-Value="pc.Diem"
                                Variant="Variant.Outlined"
                                Min="0"
                                Max="10"
                                Step="0.1"
                                Adornment="Adornment.End"
                                AdornmentText="điểm"
                                Style="width: 100%;" />
                        </MudTd>
                        <MudTd DataLabel="Ý kiến">
                            <MudTextField @bind-Value="pc.YKien"
                                          Variant="Variant.Outlined"
                                          Placeholder="Nhập ý kiến..."
                                          Lines="2"
                                          Style="width: 100%;" />
                        </MudTd>
                        <MudTd DataLabel="Thao tác">
                            <MudButton Variant="Variant.Filled" 
                                       Color="Color.Success"
                                       Size="Size.Small"
                                       StartIcon="@Icons.Material.Filled.Save"
                                       OnClick="@(() => LuuPhieu(pc, cd.Id))"
                                       Disabled="@(_isSaving || pc.Diem < 0 || pc.Diem > 10)">
                                Lưu
                            </MudButton>
                        </MudTd>
                    </RowTemplate>
                </MudTable>
            </MudPaper>
        }
    }
}

@code {
    // Authorization - khai báo trước để dùng trong template
    private bool _isAdmin = false;
    private bool _isGiaoVien = false;

    private int _activeTab = 1;
    private List<ChuyenDeNCKH> _dsChuyenDe = new();
    private List<KetQuaSoLoai> _dsKqSoLoai = new();
    private List<HoiDong> _dsHoiDong = new();
    private List<GiaoVien> _dsGiaoVien = new();
    private List<PhieuCham> _dsPhieuChamAll = new();

    private bool _isLoading = false;
    private bool _isSaving = false;
    private bool _isProcessing = false;

    protected override async Task OnInitializedAsync()
    {
        // Kiểm tra quyền truy cập
        var currentUser = await AuthService.GetCurrentUser();
        if (currentUser == null)
        {
            Navigation.NavigateTo("/login", forceLoad: true);
            return;
        }

        _isAdmin = currentUser.VaiTro == "Admin";
        _isGiaoVien = currentUser.VaiTro == "GiaoVien";
        StateHasChanged(); // Cập nhật UI sau khi set _isAdmin

        // Chỉ Admin và GiaoVien được xem trang này
        if (!_isAdmin && !_isGiaoVien)
        {
            Navigation.NavigateTo("/access-denied", forceLoad: true);
            return;
        }

        try
        {
            await LoadData();
        }
        catch (UnauthorizedException)
        {
            Navigation.NavigateTo("/access-denied", forceLoad: true);
        }
    }

    private async Task LoadData()
    {
        try
        {
            _isLoading = true;
            StateHasChanged();

            // Load từng phần để có thể xử lý lỗi riêng biệt
            try
            {
                _dsChuyenDe = await KqService.GetChuyenDe();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Lỗi tải danh sách chuyên đề: {ex.Message}", Severity.Warning);
            }

            try
            {
                _dsKqSoLoai = await KqService.GetSoLoai();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Lỗi tải kết quả sơ loại: {ex.Message}", Severity.Warning);
            }

            try
            {
                _dsHoiDong = await KqService.GetHoiDong();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Lỗi tải danh sách hội đồng: {ex.Message}", Severity.Warning);
            }

            try
            {
                _dsGiaoVien = await KqService.GetGiaoVien();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Lỗi tải danh sách giáo viên: {ex.Message}", Severity.Warning);
            }

            try
            {
                _dsPhieuChamAll = await KqService.GetAllPhieuCham();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Lỗi tải danh sách phiếu chấm: {ex.Message}", Severity.Warning);
            }
        }
        catch (UnauthorizedException)
        {
            Navigation.NavigateTo("/access-denied", forceLoad: true);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Lỗi tải dữ liệu: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private async Task LuuSoLoai(KetQuaSoLoai item)
    {
        if (item.DiemSo < 0 || item.DiemSo > 10)
        {
            Snackbar.Add("Điểm phải từ 0 đến 10!", Severity.Warning);
            return;
        }

        try
        {
            _isSaving = true;
            var result = await KqService.SaveSoLoai(item);
            
            if (result.Success)
            {
                Snackbar.Add("Lưu kết quả sơ loại thành công!", Severity.Success);
                _dsKqSoLoai = await KqService.GetSoLoai();
                StateHasChanged();
            }
            else
            {
                Snackbar.Add(result.Message, Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Lỗi: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isSaving = false;
        }
    }

    private async Task AutoXetDuyet()
    {
        var parameters = new DialogParameters
        {
            ["ContentText"] = "Bạn có chắc chắn muốn tự động xét duyệt Top 15 chuyên đề có điểm cao nhất?",
            ["ConfirmText"] = "Xác nhận",
            ["Icon"] = Icons.Material.Filled.AutoAwesome,
            ["IconColor"] = Color.Warning
        };

        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small };
        var dialog = await DialogService.ShowAsync<ConfirmDialog>("Xác nhận", parameters, options);
        var result = await dialog.Result;

        if (result == null || result.Canceled) return;

        try
        {
            _isProcessing = true;
            var apiResult = await KqService.AutoTop15();
            
            if (apiResult.Success)
            {
                Snackbar.Add($"Đã tự động xét duyệt {apiResult.Data} chuyên đề!", Severity.Success);
                await LoadData();
            }
            else
            {
                Snackbar.Add(apiResult.Message, Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Lỗi: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isProcessing = false;
        }
    }

    private bool IsPassSoLoai(int idCD)
    {
        return _dsKqSoLoai.Any(x => x.IdChuyenDe == idCD && x.KetQua == true);
    }

    private PhieuCham GetPhieuCham(int idCD, int idGV)
    {
        var pc = _dsPhieuChamAll.FirstOrDefault(x => x.IdChuyenDe == idCD && x.IdGiaoVien == idGV);
        if (pc == null)
        {
            pc = new PhieuCham { IdChuyenDe = idCD, IdGiaoVien = idGV };
            _dsPhieuChamAll.Add(pc);
        }
        return pc;
    }

    private async Task LuuPhieu(PhieuCham pc, int idChuyenDe)
    {
        if (pc.Diem < 0 || pc.Diem > 10)
        {
            Snackbar.Add("Điểm phải từ 0 đến 10!", Severity.Warning);
            return;
        }

        try
        {
            _isSaving = true;
            var result = await KqService.SavePhieuCham(pc);
            
            if (result.Success)
            {
                Snackbar.Add("Lưu phiếu chấm thành công!", Severity.Success);
                var newPcs = await KqService.GetPhieuCham(idChuyenDe);
                _dsPhieuChamAll.RemoveAll(x => x.IdChuyenDe == idChuyenDe);
                _dsPhieuChamAll.AddRange(newPcs);
                StateHasChanged();
            }
            else
            {
                Snackbar.Add(result.Message, Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Lỗi: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isSaving = false;
        }
    }

    private double CalcAverage(int idCD)
    {
        var scores = _dsPhieuChamAll.Where(x => x.IdChuyenDe == idCD && x.Diem > 0).Select(x => x.Diem).ToList();
        if (scores.Count == 0) return 0;
        return scores.Average();
    }

    [Inject] IDialogService DialogService { get; set; } = default!;
}
