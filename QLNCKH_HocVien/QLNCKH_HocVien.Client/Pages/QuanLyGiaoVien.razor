@page "/quanlygiaovien"
@using MudBlazor
@using QLNCKH_HocVien.Client.Models
@using QLNCKH_HocVien.Client.Services
@using QLNCKH_HocVien.Client.Exceptions
@using QLNCKH_HocVien.Client.Shared
@inject GiaoVienService GvService
@inject NavigationManager Navigation
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject AuthService AuthService

<PageHeader Title="QUẢN LÝ GIÁO VIÊN" 
            Subtitle="Danh sách và quản lý thông tin giáo viên" 
            Icon="@Icons.Material.Filled.Person">
    @if (_isAdmin)
    {
        <MudButton Variant="Variant.Filled" 
                   Color="Color.Surface" 
                   StartIcon="@Icons.Material.Filled.Add"
                   OnClick="OpenAddDialog"
                   Disabled="@_isLoading"
                   Style="color: white;">
            Thêm giáo viên
        </MudButton>
    }
</PageHeader>

<MudPaper Elevation="2" Class="pa-4">
    @* Search Bar *@
    <div class="d-flex gap-3 mb-4 flex-wrap">
        <MudTextField @bind-Value="_searchText"
                      Placeholder="Tìm kiếm theo mã CB, họ tên, đơn vị..."
                      Variant="Variant.Outlined"
                      Adornment="Adornment.Start"
                      AdornmentIcon="@Icons.Material.Filled.Search"
                      Immediate="true"
                      DebounceInterval="500"
                      OnDebounceIntervalElapsed="OnSearchChanged"
                      Style="max-width: 400px;"
                      Class="flex-grow-1" />
        
        <MudSelect T="int" 
                   Value="_pageSize" 
                   Label="Hiển thị"
                   Variant="Variant.Outlined"
                   Style="width: 120px;"
                   ValueChanged="@(async (int size) => await OnPageSizeChanged(size))">
            <MudSelectItem Value="5">5 / trang</MudSelectItem>
            <MudSelectItem Value="10">10 / trang</MudSelectItem>
            <MudSelectItem Value="25">25 / trang</MudSelectItem>
            <MudSelectItem Value="50">50 / trang</MudSelectItem>
        </MudSelect>
    </div>

    @* Data Table *@
    @if (_isLoading && _giaoViens.Count == 0)
    {
        <TableSkeleton Rows="5" Columns="8" />
    }
    else
    {
        <MudTable Items="@_giaoViens" 
                  Hover="true" 
                  Striped="true"
                  Dense="true"
                  Loading="@_isLoading"
                  LoadingProgressColor="Color.Primary"
                  Elevation="0"
                  Class="mb-4">
            <HeaderContent>
                <MudTh Style="width: 60px;">STT</MudTh>
                <MudTh>Mã CB</MudTh>
                <MudTh>Họ và tên</MudTh>
                <MudTh>Ngày sinh</MudTh>
                <MudTh>Giới tính</MudTh>
                <MudTh>Đơn vị</MudTh>
                <MudTh>Chức danh/Học vị</MudTh>
                <MudTh Style="width: 150px;">Thao tác</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="STT" Style="text-align: center;">
                    @((_currentPage - 1) * _pageSize + _giaoViens.IndexOf(context) + 1)
                </MudTd>
                <MudTd DataLabel="Mã CB">
                    <MudChip T="string" Color="Color.Primary" Size="Size.Small">@context.MaSoCB</MudChip>
                </MudTd>
                <MudTd DataLabel="Họ tên">
                    <MudText Typo="Typo.body2" Style="font-weight: 500;">@context.HoTen</MudText>
                </MudTd>
                <MudTd DataLabel="Ngày sinh">@context.NgaySinh?.ToString("dd/MM/yyyy")</MudTd>
                <MudTd DataLabel="Giới tính">
                    @if (context.GioiTinh == "Nam")
                    {
                        <MudChip T="string" Color="Color.Info" Size="Size.Small">Nam</MudChip>
                    }
                    else
                    {
                        <MudChip T="string" Color="Color.Secondary" Size="Size.Small">Nữ</MudChip>
                    }
                </MudTd>
                <MudTd DataLabel="Đơn vị">
                    @(_dsToChuc.FirstOrDefault(t => t.Id == context.IdDonViCongTac)?.Ten ?? "-")
                </MudTd>
                <MudTd DataLabel="Chức danh/Học vị">
                    <div>
                        @if (context.IdChucDanh.HasValue)
                        {
                            <MudChip T="string" Color="Color.Success" Size="Size.Small" Class="mb-1">
                                @(_dsChucDanh.FirstOrDefault(c => c.Id == context.IdChucDanh)?.Ten ?? "-")
                            </MudChip>
                        }
                        @if (context.IdHocVi.HasValue)
                        {
                            <MudChip T="string" Color="Color.Info" Size="Size.Small">
                                @(_dsHocVi.FirstOrDefault(h => h.Id == context.IdHocVi)?.Ten ?? "-")
                            </MudChip>
                        }
                        @if (!context.IdChucDanh.HasValue && !context.IdHocVi.HasValue)
                        {
                            <span>-</span>
                        }
                    </div>
                </MudTd>
                <MudTd DataLabel="Thao tác">
                    @if (_isAdmin)
                    {
                        <MudIconButton Icon="@Icons.Material.Filled.Edit" 
                                       Color="Color.Primary" 
                                       Size="Size.Small"
                                       OnClick="@(() => OpenEditDialog(context))" />
                        <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                       Color="Color.Error" 
                                       Size="Size.Small"
                                       OnClick="@(() => ConfirmDelete(context))" />
                    }
                    else
                    {
                        <MudText Typo="Typo.caption" Color="Color.Secondary">Chỉ xem</MudText>
                    }
                </MudTd>
            </RowTemplate>
            <NoRecordsContent>
                <MudAlert Severity="Severity.Info" Class="my-4">
                    @if (string.IsNullOrEmpty(_searchText))
                    {
                        <span>Chưa có dữ liệu giáo viên</span>
                    }
                    else
                    {
                        <span>Không tìm thấy giáo viên phù hợp với "@_searchText"</span>
                    }
                </MudAlert>
            </NoRecordsContent>
        </MudTable>

        @* Pagination *@
        <div class="d-flex justify-space-between align-center flex-wrap gap-2">
            <MudText Typo="Typo.body2" Color="Color.Secondary">
                Hiển thị @((_currentPage - 1) * _pageSize + 1) - @Math.Min(_currentPage * _pageSize, _totalCount) 
                trong tổng số @_totalCount giáo viên
            </MudText>
            
            <MudPagination Count="@_totalPages" 
                          Selected="@_currentPage"
                          ShowFirstButton="true"
                          ShowLastButton="true"
                          Color="Color.Primary"
                          Variant="Variant.Outlined"
                          SelectedChanged="@(async (int page) => await OnPageChanged(page))" />
        </div>
    }
</MudPaper>

@* Add/Edit Dialog *@
<MudDialog @bind-Visible="_showFormDialog" Options="@_dialogOptions">
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@(_isEditMode ? Icons.Material.Filled.Edit : Icons.Material.Filled.PersonAdd)" Class="mr-2" />
            @(_isEditMode ? "Cập nhật giáo viên" : "Thêm giáo viên mới")
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudForm @ref="_form" @bind-IsValid="@_formIsValid">
            <MudGrid Spacing="3">
                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="_giaoVienForm.MaSoCB"
                                  Label="Mã số cán bộ *"
                                  Variant="Variant.Outlined"
                                  Required="true"
                                  RequiredError="Vui lòng nhập mã số cán bộ"
                                  Disabled="@_isEditMode" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="_giaoVienForm.HoTen"
                                  Label="Họ và tên *"
                                  Variant="Variant.Outlined"
                                  Required="true"
                                  RequiredError="Vui lòng nhập họ tên" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudDatePicker @bind-Date="_giaoVienForm.NgaySinh"
                                   Label="Ngày sinh"
                                   Variant="Variant.Outlined"
                                   DateFormat="dd/MM/yyyy"
                                   Placeholder="Chọn ngày sinh" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudSelect @bind-Value="_giaoVienForm.GioiTinh"
                               Label="Giới tính"
                               Variant="Variant.Outlined">
                        <MudSelectItem Value="@("Nam")">Nam</MudSelectItem>
                        <MudSelectItem Value="@("Nữ")">Nữ</MudSelectItem>
                    </MudSelect>
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudSelect T="int?" 
                               @bind-Value="_giaoVienForm.IdTinh"
                               Label="Quê quán"
                               Variant="Variant.Outlined"
                               Clearable="true">
                        @foreach (var t in _dsTinh)
                        {
                            <MudSelectItem T="int?" Value="@t.IdTinh">@t.TenTinh</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="_giaoVienForm.SoDienThoai"
                                  Label="Số điện thoại"
                                  Variant="Variant.Outlined" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudSelect T="int?" 
                               @bind-Value="_giaoVienForm.IdDanToc"
                               Label="Dân tộc"
                               Variant="Variant.Outlined"
                               Clearable="true">
                        @foreach (var d in _dsDanToc)
                        {
                            <MudSelectItem T="int?" Value="@d.IdDanToc">@d.TenDanToc</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudSelect T="int?" 
                               @bind-Value="_giaoVienForm.IdTonGiao"
                               Label="Tôn giáo"
                               Variant="Variant.Outlined"
                               Clearable="true">
                        @foreach (var t in _dsTonGiao)
                        {
                            <MudSelectItem T="int?" Value="@t.IdTonGiao">@t.TenTonGiao</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudSelect T="int?" 
                               @bind-Value="_giaoVienForm.IdTrinhDoChuyenMon"
                               Label="Trình độ chuyên môn"
                               Variant="Variant.Outlined"
                               Clearable="true">
                        @foreach (var td in _dsTrinhDoChuyenMon)
                        {
                            <MudSelectItem T="int?" Value="@td.Id">@td.Ten</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudSelect T="int?" 
                               @bind-Value="_giaoVienForm.IdTrinhDoLLCT"
                               Label="Trình độ lý luận chính trị"
                               Variant="Variant.Outlined"
                               Clearable="true">
                        @foreach (var td in _dsTrinhDoLLCT)
                        {
                            <MudSelectItem T="int?" Value="@td.Id">@td.Ten</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudSelect T="int?" 
                               @bind-Value="_giaoVienForm.IdDonViCongTac"
                               Label="Đơn vị công tác"
                               Variant="Variant.Outlined"
                               Clearable="true">
                        @foreach (var dv in _dsToChuc)
                        {
                            <MudSelectItem T="int?" Value="@dv.Id">@dv.Ten</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudSelect T="int?" 
                               @bind-Value="_giaoVienForm.IdChucVu"
                               Label="Chức vụ"
                               Variant="Variant.Outlined"
                               Clearable="true">
                        @foreach (var cv in _dsChucVu)
                        {
                            <MudSelectItem T="int?" Value="@cv.IdChucVu">@cv.TenChucVu</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudSelect T="int?" 
                               @bind-Value="_giaoVienForm.IdCapBac"
                               Label="Cấp bậc"
                               Variant="Variant.Outlined"
                               Clearable="true">
                        @foreach (var cb in _dsCapBac)
                        {
                            <MudSelectItem T="int?" Value="@cb.Id">@cb.Ten</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudNumericField T="double?" 
                                    @bind-Value="_giaoVienForm.HeSoLuong"
                                    Label="Hệ số lương"
                                    Variant="Variant.Outlined"
                                    Min="0"
                                    Max="10"
                                    Step="0.1" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudSelect T="int?" 
                               @bind-Value="_giaoVienForm.IdChucDanh"
                               Label="Chức danh"
                               Variant="Variant.Outlined"
                               Clearable="true">
                        @foreach (var cd in _dsChucDanh)
                        {
                            <MudSelectItem T="int?" Value="@cd.Id">@cd.Ten</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudSelect T="int?" 
                               @bind-Value="_giaoVienForm.IdHocHam"
                               Label="Học hàm"
                               Variant="Variant.Outlined"
                               Clearable="true">
                        @foreach (var hh in _dsHocHam)
                        {
                            <MudSelectItem T="int?" Value="@hh.Id">@hh.Ten</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudSelect T="int?" 
                               @bind-Value="_giaoVienForm.IdHocVi"
                               Label="Học vị"
                               Variant="Variant.Outlined"
                               Clearable="true">
                        @foreach (var hv in _dsHocVi)
                        {
                            <MudSelectItem T="int?" Value="@hv.Id">@hv.Ten</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>
                <MudItem xs="12">
                    <MudTextField @bind-Value="_giaoVienForm.LinhVuc"
                                  Label="Lĩnh vực chuyên môn"
                                  Variant="Variant.Outlined"
                                  Lines="2" />
                </MudItem>
            </MudGrid>
        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="CloseFormDialog" Disabled="@_isSaving">Hủy</MudButton>
        <MudButton Color="Color.Primary" 
                   Variant="Variant.Filled"
                   OnClick="SaveGiaoVien"
                   Disabled="@(!_formIsValid || _isSaving)">
            @if (_isSaving)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                <span>Đang lưu...</span>
            }
            else
            {
                <MudIcon Icon="@Icons.Material.Filled.Save" Class="mr-1" />
                <span>Lưu</span>
            }
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    // Data
    private List<GiaoVien> _giaoViens = new();
    private List<Tinh> _dsTinh = new();
    private List<DanToc> _dsDanToc = new();
    private List<TonGiao> _dsTonGiao = new();
    private List<TrinhDoChuyenMon> _dsTrinhDoChuyenMon = new();
    private List<TrinhDoLLCT> _dsTrinhDoLLCT = new();
    private List<ToChuc> _dsToChuc = new();
    private List<ChucVu> _dsChucVu = new();
    private List<CapBac> _dsCapBac = new();
    private List<ChucDanh> _dsChucDanh = new();
    private List<HocHam> _dsHocHam = new();
    private List<HocVi> _dsHocVi = new();

    // Pagination
    private int _currentPage = 1;
    private int _pageSize = 10;
    private int _totalCount = 0;
    private int _totalPages => (int)Math.Ceiling(_totalCount / (double)_pageSize);

    // Search
    private string _searchText = "";

    // Form
    private GiaoVien _giaoVienForm = new();
    private bool _showFormDialog = false;
    private bool _isEditMode = false;
    private bool _formIsValid = false;
    private bool _isSaving = false;
    private MudForm? _form;

    // Loading
    private bool _isLoading = false;

    // Authorization
    private bool _isAdmin = false;
    private bool _isGiaoVien = false;

    // Dialog options
    private DialogOptions _dialogOptions = new()
    {
        MaxWidth = MaxWidth.Large,
        FullWidth = true,
        CloseOnEscapeKey = true,
        BackdropClick = false
    };

    protected override async Task OnInitializedAsync()
    {
        // Kiểm tra quyền truy cập
        var currentUser = await AuthService.GetCurrentUser();
        if (currentUser == null)
        {
            Navigation.NavigateTo("/login", forceLoad: true);
            return;
        }

        _isAdmin = currentUser.VaiTro == "Admin";
        _isGiaoVien = currentUser.VaiTro == "GiaoVien";

        // Chỉ Admin và GiaoVien được xem trang này
        if (!_isAdmin && !_isGiaoVien)
        {
            Navigation.NavigateTo("/access-denied", forceLoad: true);
            return;
        }

        try
        {
            // Load catalogs in parallel
            var tasks = new[]
            {
                LoadCatalogAsync(async () => _dsTinh = await GvService.LayDsTinh()),
                LoadCatalogAsync(async () => _dsDanToc = await GvService.LayDsDanToc()),
                LoadCatalogAsync(async () => _dsTonGiao = await GvService.LayDsTonGiao()),
                LoadCatalogAsync(async () => _dsTrinhDoChuyenMon = await GvService.LayDsTrinhDoChuyenMon()),
                LoadCatalogAsync(async () => _dsTrinhDoLLCT = await GvService.LayDsTrinhDoLLCT()),
                LoadCatalogAsync(async () => _dsToChuc = await GvService.LayDsToChuc()),
                LoadCatalogAsync(async () => _dsChucVu = await GvService.LayDsChucVu()),
                LoadCatalogAsync(async () => _dsCapBac = await GvService.LayDsCapBac()),
                LoadCatalogAsync(async () => _dsChucDanh = await GvService.LayDsChucDanh()),
                LoadCatalogAsync(async () => _dsHocHam = await GvService.LayDsHocHam()),
                LoadCatalogAsync(async () => _dsHocVi = await GvService.LayDsHocVi())
            };
            await Task.WhenAll(tasks);

            // Load data
            await LoadDataAsync();
        }
        catch (UnauthorizedException)
        {
            Navigation.NavigateTo("/access-denied", forceLoad: true);
        }
    }

    private async Task LoadCatalogAsync(Func<Task> action)
    {
        try { await action(); } catch { }
    }

    private async Task LoadDataAsync()
    {
        try
        {
            _isLoading = true;
            StateHasChanged();

            var result = await GvService.LayDanhSachPhanTrang(_currentPage, _pageSize, _searchText);
            _giaoViens = result.Data ?? new List<GiaoVien>();
            _totalCount = result.TotalCount;
        }
        catch (UnauthorizedException)
        {
            Navigation.NavigateTo("/access-denied", forceLoad: true);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Lỗi tải dữ liệu: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task OnSearchChanged(string value)
    {
        _searchText = value;
        _currentPage = 1;
        await LoadDataAsync();
    }

    private async Task OnPageChanged(int page)
    {
        _currentPage = page;
        await LoadDataAsync();
    }

    private async Task OnPageSizeChanged(int size)
    {
        _pageSize = size;
        _currentPage = 1;
        await LoadDataAsync();
    }

    private void OpenAddDialog()
    {
        _giaoVienForm = new GiaoVien();
        _isEditMode = false;
        _showFormDialog = true;
    }

    private void OpenEditDialog(GiaoVien gv)
    {
        _giaoVienForm = new GiaoVien
        {
            Id = gv.Id,
            MaSoCB = gv.MaSoCB,
            HoTen = gv.HoTen,
            NgaySinh = gv.NgaySinh,
            GioiTinh = gv.GioiTinh,
            IdTinh = gv.IdTinh,
            IdXa = gv.IdXa,
            IdDanToc = gv.IdDanToc,
            IdTonGiao = gv.IdTonGiao,
            SoDienThoai = gv.SoDienThoai,
            IdTrinhDoChuyenMon = gv.IdTrinhDoChuyenMon,
            IdTrinhDoLLCT = gv.IdTrinhDoLLCT,
            IdDonViCongTac = gv.IdDonViCongTac,
            IdChucVu = gv.IdChucVu,
            IdCapBac = gv.IdCapBac,
            HeSoLuong = gv.HeSoLuong,
            IdChucDanh = gv.IdChucDanh,
            IdHocHam = gv.IdHocHam,
            IdHocVi = gv.IdHocVi,
            LinhVuc = gv.LinhVuc
        };
        _isEditMode = true;
        _showFormDialog = true;
    }

    private void CloseFormDialog()
    {
        if (!_isSaving)
        {
            _showFormDialog = false;
        }
    }

    private async Task SaveGiaoVien()
    {
        if (_form != null)
        {
            await _form.Validate();
            if (!_formIsValid) return;
        }

        try
        {
            _isSaving = true;

            if (_isEditMode)
            {
                var result = await GvService.CapNhatGiaoVien(_giaoVienForm);
                if (result.Success)
                {
                    Snackbar.Add("Cập nhật giáo viên thành công!", Severity.Success);
                    _showFormDialog = false;
                    await LoadDataAsync();
                }
                else
                {
                    Snackbar.Add(result.Message, Severity.Error);
                }
            }
            else
            {
                var result = await GvService.ThemGiaoVien(_giaoVienForm);
                if (result.Success)
                {
                    Snackbar.Add("Thêm giáo viên thành công!", Severity.Success);
                    _showFormDialog = false;
                    await LoadDataAsync();
                }
                else
                {
                    Snackbar.Add(result.Message, Severity.Error);
                }
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Lỗi: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isSaving = false;
        }
    }

    private async Task ConfirmDelete(GiaoVien gv)
    {
        var parameters = new DialogParameters
        {
            ["ContentText"] = $"Bạn có chắc chắn muốn xóa giáo viên '{gv.HoTen}' ({gv.MaSoCB})?",
            ["ConfirmText"] = "Xóa",
            ["Icon"] = Icons.Material.Filled.DeleteForever,
            ["IconColor"] = Color.Error
        };

        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small };
        var dialog = await DialogService.ShowAsync<ConfirmDialog>("Xác nhận xóa", parameters, options);
        var result = await dialog.Result;

        if (result != null && !result.Canceled)
        {
            await DeleteGiaoVien(gv.Id);
        }
    }

    private async Task DeleteGiaoVien(int id)
    {
        try
        {
            _isLoading = true;
            var result = await GvService.XoaGiaoVien(id);
            
            if (result.Success)
            {
                Snackbar.Add("Xóa giáo viên thành công!", Severity.Success);
                await LoadDataAsync();
            }
            else
            {
                Snackbar.Add(result.Message, Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Lỗi xóa: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }
}
