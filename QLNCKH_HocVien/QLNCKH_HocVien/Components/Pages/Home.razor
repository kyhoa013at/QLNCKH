@page "/"
@using MudBlazor
@using System.Security.Claims
@using QLNCKH_HocVien.Client.Services
@using QLNCKH_HocVien.Client.Exceptions
@using QLNCKH_HocVien.Client.Models
@inject IHttpContextAccessor HttpContextAccessor
@inject SinhVienService SinhVienService
@inject GiaoVienService GiaoVienService
@inject ChuyenDeNCKHService ChuyenDeService
@inject XepGiaiService XepGiaiService
@inject DashboardService DashboardService
@inject NavigationManager Navigation

<PageTitle>Trang chủ - QLNCKH</PageTitle>

<MudGrid Spacing="4">
    @* Welcome Banner *@
    <MudItem xs="12">
        <MudPaper Elevation="3" Class="pa-6" Style="background: linear-gradient(135deg, #1976D2 0%, #1565C0 50%, #0D47A1 100%); border-radius: 16px;">
            <div class="d-flex justify-space-between align-center flex-wrap gap-4">
                <div>
                    <MudText Typo="Typo.h4" Style="color: white; font-weight: 700;">
                        Xin chào, @_userName! 👋
                    </MudText>
                    <MudText Typo="Typo.subtitle1" Style="color: rgba(255,255,255,0.85);" Class="mt-2">
                        Hệ thống Quản lý Nghiên cứu Khoa học Học viên
                    </MudText>
                    <MudText Typo="Typo.body2" Style="color: rgba(255,255,255,0.7);" Class="mt-1">
                        @DateTime.Now.ToString("dddd, dd MMMM yyyy", new System.Globalization.CultureInfo("vi-VN"))
                    </MudText>
                </div>
                <MudAvatar Size="Size.Large" Style="background: rgba(255,255,255,0.2); width: 80px; height: 80px;">
                    <MudIcon Icon="@Icons.Material.Filled.Science" Size="Size.Large" Style="color: white;" />
                </MudAvatar>
            </div>
        </MudPaper>
    </MudItem>

    @* Quick Stats *@
    <MudItem xs="12" sm="6" md="3">
        <MudPaper Elevation="2" Class="pa-4 d-flex align-center gap-3" Style="border-radius: 12px;">
            <MudAvatar Color="Color.Primary" Variant="Variant.Filled" Size="Size.Large">
                <MudIcon Icon="@Icons.Material.Filled.School" />
            </MudAvatar>
            <div>
                @if (_isLoading)
                {
                    <MudSkeleton Width="60px" Height="32px" Animation="Animation.Wave" />
                }
                else
                {
                    <MudText Typo="Typo.h5" Color="Color.Primary">@_tongSinhVien</MudText>
                }
                <MudText Typo="Typo.body2" Color="Color.Secondary">Sinh viên</MudText>
            </div>
        </MudPaper>
    </MudItem>

    <MudItem xs="12" sm="6" md="3">
        <MudPaper Elevation="2" Class="pa-4 d-flex align-center gap-3" Style="border-radius: 12px;">
            <MudAvatar Color="Color.Secondary" Variant="Variant.Filled" Size="Size.Large">
                <MudIcon Icon="@Icons.Material.Filled.SupervisorAccount" />
            </MudAvatar>
            <div>
                @if (_isLoading)
                {
                    <MudSkeleton Width="60px" Height="32px" Animation="Animation.Wave" />
                }
                else
                {
                    <MudText Typo="Typo.h5" Color="Color.Secondary">@_tongGiaoVien</MudText>
                }
                <MudText Typo="Typo.body2" Color="Color.Secondary">Giáo viên</MudText>
            </div>
        </MudPaper>
    </MudItem>

    <MudItem xs="12" sm="6" md="3">
        <MudPaper Elevation="2" Class="pa-4 d-flex align-center gap-3" Style="border-radius: 12px;">
            <MudAvatar Color="Color.Success" Variant="Variant.Filled" Size="Size.Large">
                <MudIcon Icon="@Icons.Material.Filled.MenuBook" />
            </MudAvatar>
            <div>
                @if (_isLoading)
                {
                    <MudSkeleton Width="60px" Height="32px" Animation="Animation.Wave" />
                }
                else
                {
                    <MudText Typo="Typo.h5" Color="Color.Success">@_tongChuyenDe</MudText>
                }
                <MudText Typo="Typo.body2" Color="Color.Secondary">Chuyên đề</MudText>
            </div>
        </MudPaper>
    </MudItem>

    <MudItem xs="12" sm="6" md="3">
        <MudPaper Elevation="2" Class="pa-4 d-flex align-center gap-3" Style="border-radius: 12px;">
            <MudAvatar Color="Color.Warning" Variant="Variant.Filled" Size="Size.Large">
                <MudIcon Icon="@Icons.Material.Filled.EmojiEvents" />
            </MudAvatar>
            <div>
                @if (_isLoading)
                {
                    <MudSkeleton Width="60px" Height="32px" Animation="Animation.Wave" />
                }
                else
                {
                    <MudText Typo="Typo.h5" Color="Color.Warning">@_tongXepGiai</MudText>
                }
                <MudText Typo="Typo.body2" Color="Color.Secondary">Đã xếp giải</MudText>
            </div>
        </MudPaper>
    </MudItem>

    @* Quick Actions *@
    <MudItem xs="12" md="6">
        <MudPaper Elevation="2" Class="pa-4" Style="border-radius: 12px;">
            <MudText Typo="Typo.h6" Class="mb-3">
                <MudIcon Icon="@Icons.Material.Filled.Speed" Class="mr-2" />
                Thao tác nhanh
            </MudText>
            <MudGrid Spacing="2">
                <MudItem xs="6">
                    <MudButton Variant="Variant.Outlined" 
                               Color="Color.Primary" 
                               FullWidth="true"
                               StartIcon="@Icons.Material.Filled.PersonAdd"
                               Href="/quanlysinhvien"
                               Class="py-3">
                        Thêm Sinh viên
                    </MudButton>
                </MudItem>
                <MudItem xs="6">
                    <MudButton Variant="Variant.Outlined" 
                               Color="Color.Success" 
                               FullWidth="true"
                               StartIcon="@Icons.Material.Filled.NoteAdd"
                               Href="/dangkychuyende"
                               Class="py-3">
                        Đăng ký CĐ
                    </MudButton>
                </MudItem>
                <MudItem xs="6">
                    <MudButton Variant="Variant.Outlined" 
                               Color="Color.Info" 
                               FullWidth="true"
                               StartIcon="@Icons.Material.Filled.CloudUpload"
                               Href="/nopchuyende"
                               Class="py-3">
                        Nộp sản phẩm
                    </MudButton>
                </MudItem>
                <MudItem xs="6">
                    <MudButton Variant="Variant.Outlined" 
                               Color="Color.Warning" 
                               FullWidth="true"
                               StartIcon="@Icons.Material.Filled.Grading"
                               Href="/capnhatketqua"
                               Class="py-3">
                        Chấm điểm
                    </MudButton>
                </MudItem>
            </MudGrid>
        </MudPaper>
    </MudItem>

    @* Recent Activities *@
    <MudItem xs="12" md="6">
        <MudPaper Elevation="2" Class="pa-4" Style="border-radius: 12px;">
            <MudText Typo="Typo.h6" Class="mb-3">
                <MudIcon Icon="@Icons.Material.Filled.History" Class="mr-2" />
                Hoạt động gần đây
            </MudText>
            @if (_isLoadingActivities)
            {
                <MudList T="string" Dense="true">
                    @for (int i = 0; i < 4; i++)
                    {
                        <MudListItem T="string">
                            <MudSkeleton Height="40px" Width="100%" Animation="Animation.Wave" />
                        </MudListItem>
                    }
                </MudList>
            }
            else if (_recentActivities.Count == 0)
            {
                <MudAlert Severity="Severity.Info">Chưa có hoạt động nào</MudAlert>
            }
            else
            {
                <div>
                    @foreach (var activity in _recentActivities)
                    {
                        <div class="d-flex align-center gap-3 mb-3 pb-3" style="border-bottom: 1px solid rgba(0,0,0,0.12);">
                            <MudIcon Icon="@GetIcon(activity.Icon)" Color="@GetColor(activity.IconColor)" Size="Size.Medium" />
                            <div style="flex: 1;">
                                <MudText Typo="Typo.body2" Style="font-weight: 500;">@activity.Title</MudText>
                                @if (!string.IsNullOrEmpty(activity.Description))
                                {
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">@activity.Description</MudText>
                                }
                            </div>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">@activity.TimeAgo</MudText>
                        </div>
                    }
                </div>
            }
        </MudPaper>
    </MudItem>

    @* Workflow Guide *@
    <MudItem xs="12">
        <MudPaper Elevation="2" Class="pa-4" Style="border-radius: 12px;">
            <MudText Typo="Typo.h6" Class="mb-4">
                <MudIcon Icon="@Icons.Material.Filled.Timeline" Class="mr-2" />
                Quy trình NCKH
            </MudText>
            <MudTimeline TimelinePosition="TimelinePosition.Alternate">
                <MudTimelineItem Color="Color.Primary" Variant="Variant.Filled">
                    <ItemContent>
                        <MudText Typo="Typo.subtitle2" Style="font-weight: 600;">1. Quản lý danh mục</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">Thêm thông tin sinh viên, giáo viên</MudText>
                    </ItemContent>
                </MudTimelineItem>
                <MudTimelineItem Color="Color.Success" Variant="Variant.Filled">
                    <ItemContent>
                        <MudText Typo="Typo.subtitle2" Style="font-weight: 600;">2. Đăng ký chuyên đề</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">Sinh viên đăng ký đề tài nghiên cứu</MudText>
                    </ItemContent>
                </MudTimelineItem>
                <MudTimelineItem Color="Color.Info" Variant="Variant.Filled">
                    <ItemContent>
                        <MudText Typo="Typo.subtitle2" Style="font-weight: 600;">3. Nộp sản phẩm</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">Nộp bản mềm, bản cứng, chỉnh sửa</MudText>
                    </ItemContent>
                </MudTimelineItem>
                <MudTimelineItem Color="Color.Tertiary" Variant="Variant.Filled">
                    <ItemContent>
                        <MudText Typo="Typo.subtitle2" Style="font-weight: 600;">4. Lập hội đồng</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">Tạo hội đồng chấm sơ loại, chung khảo</MudText>
                    </ItemContent>
                </MudTimelineItem>
                <MudTimelineItem Color="Color.Warning" Variant="Variant.Filled">
                    <ItemContent>
                        <MudText Typo="Typo.subtitle2" Style="font-weight: 600;">5. Chấm điểm</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">Vòng sơ loại → Vòng chung khảo</MudText>
                    </ItemContent>
                </MudTimelineItem>
                <MudTimelineItem Color="Color.Error" Variant="Variant.Filled">
                    <ItemContent>
                        <MudText Typo="Typo.subtitle2" Style="font-weight: 600;">6. Xếp giải</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">Tính điểm và xếp hạng giải thưởng</MudText>
                    </ItemContent>
                </MudTimelineItem>
            </MudTimeline>
        </MudPaper>
    </MudItem>
</MudGrid>

@code {
    private string _userName = "Người dùng";
    private int _tongSinhVien = 0;
    private int _tongGiaoVien = 0;
    private int _tongChuyenDe = 0;
    private int _tongXepGiai = 0;
    private bool _isLoading = true;
    private bool _isLoadingActivities = true;
    private List<RecentActivity> _recentActivities = new();

    protected override async Task OnInitializedAsync()
    {
        var httpContext = HttpContextAccessor.HttpContext;
        if (httpContext?.User?.Identity?.IsAuthenticated == true)
        {
            _userName = httpContext.User.FindFirst(ClaimTypes.GivenName)?.Value ?? 
                       httpContext.User.Identity?.Name ?? "Người dùng";
        }

        await Task.WhenAll(LoadStatistics(), LoadRecentActivities());
    }

    private async Task LoadRecentActivities()
    {
        try
        {
            _isLoadingActivities = true;
            StateHasChanged();

            _recentActivities = await DashboardService.GetRecentActivities(10);
        }
        catch (UnauthorizedException)
        {
            Navigation.NavigateTo("/access-denied", forceLoad: true);
        }
        catch (Exception)
        {
            // Ignore errors
        }
        finally
        {
            _isLoadingActivities = false;
            StateHasChanged();
        }
    }

    private async Task LoadStatistics()
    {
        try
        {
            _isLoading = true;
            StateHasChanged();

            // Load tất cả số liệu song song để tối ưu performance
            var t1 = LoadCountAsync(async () => 
            {
                var list = await SinhVienService.LayTatCaSinhVien();
                _tongSinhVien = list.Count;
            });
            var t2 = LoadCountAsync(async () => 
            {
                var list = await GiaoVienService.LayTatCaGiaoVien();
                _tongGiaoVien = list.Count;
            });
            var t3 = LoadCountAsync(async () => 
            {
                var list = await ChuyenDeService.LayDsChuyenDe();
                _tongChuyenDe = list.Count;
            });
            var t4 = LoadCountAsync(async () => 
            {
                var list = await XepGiaiService.LayKetQua();
                _tongXepGiai = list.Count;
            });

            await Task.WhenAll(t1, t2, t3, t4);
        }
        catch (UnauthorizedException)
        {
            Navigation.NavigateTo("/access-denied", forceLoad: true);
        }
        catch (Exception)
        {
            // Ignore errors để không làm crash trang chủ
            // Có thể log error nếu cần
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private async Task LoadCountAsync(Func<Task> action)
    {
        try 
        { 
            await action(); 
        } 
        catch 
        { 
            // Ignore individual errors
        }
    }

    private string GetIcon(string iconName)
    {
        return iconName switch
        {
            "PersonAdd" => Icons.Material.Filled.PersonAdd,
            "NoteAdd" => Icons.Material.Filled.NoteAdd,
            "CloudUpload" => Icons.Material.Filled.CloudUpload,
            "Groups" => Icons.Material.Filled.Groups,
            "Grading" => Icons.Material.Filled.Grading,
            "EmojiEvents" => Icons.Material.Filled.EmojiEvents,
            _ => Icons.Material.Filled.Info
        };
    }

    private Color GetColor(string colorName)
    {
        return colorName switch
        {
            "Primary" => Color.Primary,
            "Success" => Color.Success,
            "Info" => Color.Info,
            "Warning" => Color.Warning,
            "Error" => Color.Error,
            "Tertiary" => Color.Tertiary,
            _ => Color.Default
        };
    }
}
